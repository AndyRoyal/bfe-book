# HTTPS的优化

## HTTPS化背景及必要性

伴随着互联网的飞速发展及用户规模的迅猛增长，互联网长期面临着严峻的安全威胁和数据隐私风险。围绕HTTP流量的黑产在非法牟利同时，对互联网用户体验及安全隐私带来严重的影响，也给互联网服务提供商的声誉和利益带来巨大损失。使用HTTP协议面临的典型问题包括：
- **内容篡改**：用户访问的页面内容被恶意篡改，例如搜索结果页链接被恶意修改、下载页面安装包被恶意替换、浏览页面植入大量广告等
- **隐私泄露**：用户网络活动信息被嗅探，个人数据被泄漏及利用，受到垃圾短信或诈骗电话干扰等
- **流量劫持**：用户访问被劫持到钓鱼网站，用户账号信息在诱导下被窃取等

HTTPS相比HTTP协议在底层使用了TLS协议传输，提供完整性、私密性、身份认证机制，可以保障互联网用户流量的接入安全。国内外诸多大型互联网公司已经全面支持HTTPS。浏览器厂商、移动应用商店等生态厂商也在加速推进HTTPS。例如：

- iOS10 ATS (App Transport Security) 策略强制要求所以在iOS 应用商店上架的应用都必须支持HTTPS。
- Chrome浏览器在HTTP域名输入框前增加“不安全”的提示。Google正推动 Chrome 浏览器将 HTTPS作为默认设置（而非 HTTP）。用户直接输入域名后，Chrome 将首先尝试使用 HTTPS协议访问。

## HTTPS化问题及优化

对于一个中大型的网站而言，全面HTTPS化除了需完成网站页面HTTPS改造，还面临以下主要问题：

- **访问速度问题**：HTTPS相比HTTP一般会额外引入1～2个RTT。这还不包括用户首先访问HTTP然后跳转到HTTPS、HTTPS连接握手过程中证书状态检查所引入的延迟。在移动网络环境下更大的往返延迟，还会带来更明显的影响。


- **性能及成本问题**：TLS协议握手及数据加密传输引入的密码学计算，带来不可忽视的性能开销。尤其是TLS握手过程中的非对称计算，是性能开源的主要来源。以Nginx为例，在短连接及完全握手情况下，HTTP相比HTTPS吞吐高达10倍。


- **安全性问题**：正确的部署及保障HTTPS安全性，需掌握一定的安全领域知识及最佳实践。运维人员往往容易在HTTPS部署时留下安全隐患，无法满足安全合规要求。


- **可用性问题**：




## BFE相关增强机制

BFE使用的golang官方TLS协议提供了成熟稳定的实现。为更好适应于大型站点，进行了一些针对性的改进，重点说明如下。


### 分布式TLS会话缓存

BFE支持将TLS会话状态存储中分布式Cache集群中，从而提升在集群部署模式下的TLS会话复用率。



### TLS会话状态格式 

在分布式TLS会话缓存保存的会话状态，可以采用两种格式：原始格式及OpenSSL格式。
如果是BFE新用户，可优先使用原始格式。这种格式相比OpenSSL兼容格式可以降低分布式TLS会话缓存的存储开销。

如果是基于OpenSSL反向代理的用户，如果需要替换为BFE或同时两种程序提供服务，可以将通过配置为OpenSSL格式，以便兼容读取各方保存的会话状态。



### Session Ticket密钥更新

如果Session Ticket key出现泄漏，将无法保障前向安全性。基于Session Ticket进行会话复用的连接，恶意攻击者通过预先录制流量，并使用泄漏的Session Ticket key，可以成功计算出连接的密钥并解密出明文信息。

为了避免以上问题，需定期更新Session Ticket key文件。BFE支持热加载并更新Session Ticket key。



### OSCP Staple的自适应容错

OCSP Staple文件具有有效期，如果在握手过程中发送一个意外过期的OCSP Staple文件，可能导致握手失败。

在一个大规模的分布式集群环境中，定期保持OCSP Staple高频的及时更新，容易由于流程原因导致OCSP Staple未及时成功更新或遗漏更新。

BFE支持自适应处理即将过期的OCSP Staple文件，在OCSP Staple即将过期时，将自动降级并停止使用该OCSP Staple文件


### 非对称密码学计算优化

非对称密钥算法在TLS握手过程中一般用于身份认证及密钥交换。目前主流的非对称算法包含RSA/ECC。

由于CA根证书兼容性原因，RSA类型证书依然是目前最广泛使用的证书。目前RSA算法建议的安全长度是2048，相比同安全强度更高的ECC算法而言，RSA算法的性能开销要远大于ECC。

如果用户流量全部来业务自有移动端，或用户握手报文满足一定特征（例如QUIC），可通过选择ECC类型证书及私钥来减少非对称密码学计算引入性能开销。

如果需兼容大量低端客户端，通过基于硬件加速的方式，也可以大大减少RSA计算引入性能开销。基于硬件加速的方式一般有两种方案：
1. 同机部署支持RSA加速的新一代CPU或部署RSA硬件加速扩展卡
2. 远程访问具有RSA硬件加速条件的非对称计算服务

方式2相比方式1的优势是：
1. 不必全面升级现有的转发机器，降级升级周期及成本
2. 可以灵活适配转发机器的非对称计算需求，避免硬件加速卡（基于硬件扩展卡）
3. 可以为密钥提供集中式、基于硬件的安全保护机制（基于CPU特殊指令）

由于远程硬件加速服务难以达到100%的可用性，为避免引入依赖服务降低整体可用性，在访问远程硬件加速卡出现偶发异常时，通过自动降级使用本地计算来消除影响。


### 多证书选择

在多租户的环境中，需要为不同的租户使用不同的证书。同一个租户由于业务原因（例如品牌考虑），也可能使用了多个证书。

在实际部署中，BFE为不同租户提供了不同的VIP；可以为不同的VIP配置不同的证书。


### 心脏出血问题

由于Golang内置的内存安全机制，可以避免由于C语言常见的缓冲区异常内存问题，所引发的安全问题。


### TLS安全等级

正确配置服务的各项TLS/SSL参数（协议版本、加密套件）需要运维人员对TLS/SSL安全具备较深入的理解。为降低管理员误配置引入的安全风险，BFE提供了四种TLS安全等级：

| 安全等级 | 说明                   |
| -------- | ---------------------- |
| 等级A+   | 安全性最高、兼容性最低 |
| 等级A    | 安全性较高、兼容性一般 |
| 等级B    | 安全性一般、兼容性较高 |
| 等级C    | 安全性最低、兼容性最高 |


### TLS/SSL JA3指纹

BFE支可根据ClientHello消息中信息计算TLS/SSL客户端的指纹。BFE采用了JA3算法，可简单及高效的检查客户端程序。


### 证书灰度更新

证书变更是一个相对高风险的操作。签发证书缺失必要扩展、证书链配置错误、证书链更新中级CA证书等，都可能触发兼容性问题，导致证书更新后部分用户访问异常。

对普通运维人员而言，能细粒度灰度更新证书，并区分证书比较，是控制变更风险、快速发现潜在问题的一个关键手段。

BFE支持按用户抽样灰度更新证书，并实现统计比较新旧证书握手成功率变化，可以快速拦截在小流量阶段难以从总流量波动中观察到的异常。


