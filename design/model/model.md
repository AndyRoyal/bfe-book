# BFE的转发模型

对于一个七层负载均衡软件来说，转发模型是它的核心。本章首先对BFE的转发模型做一个概要的介绍。在后面的章节中，会详细介绍BFE的路由转发机制和内网流量调度机制。

## 基本概念

在BFE中，有以下基本概念：

+ 租户（Tenant）

  使用BFE转发的业务，可以基于“租户”的单位来区分。BFE引擎中的配置，比如转发策略、各扩展模块的配置等，都是以租户为单位来区分的。

  由于历史原因，在BFE中，租户也被称为“产品线”（Product）。

+ 集群（Cluster）

  具有同类功能的后端定义为一个集群(Cluster)。对于一个租户，可以定义多个集群。在某些场景，集群也被称为服务（Service）。

  在一个租户内，可以使用租户的路由转发表将流量转发给合适的集群。详细的机制可以参考后面章节中关于BFE路由转发机制的说明。

+ 子集群（Sub Cluster）

  在多数据中心场景下，集群可以划分为多个子集群(Sub Cluster)。通常，可以将集群中处于同一IDC中的后端定义为一个子集群。

  子集群概念的引入，主要是为了处理多数据中心场景下的流量调度。详细的机制可以参考后面章节中关于BFE内网流量调度机制的说明。
+ 实例（Instance）

  每个子集群可包含多个后端服务实例(Instance)。每个后端实例通过"IP地址 + 端口号"标识。
## 转发过程

![forward model](./traffic-forward.png)

下面以上图为例，说明BFE的转发过程。

这里是一个多数据中心的场景，包含3个数据中心（IDC1至 IDC3），在3个数据中心各有一个外网出口。这3个数据中心可能在临近区域内（一般被称为Region），也可能不在同一地域内。

在每个数据中心内，都部署了4层负载均衡集群，也部署了基于BFE的7层负载均衡集群。在一般的部署场景下，BFE都是作为四层负载均衡的RS（Real Server）存在。在一个BFE集群中，一般都会包含2个以上BFE运行实例，位于不同的服务器上。在某个BFE实例出现故障（由于服务器硬件、操作系统、或BFE自身的问题）的情况下，四层负载均衡系统可以自动摘除有问题的实例，从而实现高可用（HA：High Availability）。

这里我们假设有一个提供静态页面访问的服务，命名为demo-static。这个服务在3个数据中心中都有部署，组织为3个独立的子集群（demo-static.idc1 至 demo-static.idc3）。

demo-static使用demo.example.com域名来对外提供服务。在3个数据中心各分配了一个外网IP，假设分别为6.6.6.6、7.7.7.7和8.8.8.8（注：这些域名和IP地址都是虚构的，仅用于说明BFE的运行机制）。

客户端要访问demo-static服务，首先要进行域名解析，将域名解析为合适的IP地址。在上图的步骤1和2中，根据客户端的来源地，智能DNS返回IP地址为6.6.6.6。

之后客户端向6.6.6.6地址的80端口发起建立TCP连接。为了使案例简单，这里假设客户端和服务端使用普通HTTP协议交互，而没有使用HTTPS协议。通过四层负载均衡系统的代理，最终客户端和BFE集群中的某个BFE实例建立起TCP连接。在一个TCP连接内，可以发送1个或多个HTTP请求。一个连接内发送HTTP请求的数量，被称为连接复用率。在HTTP/2出现之前，一般场景下的连接复用率为2-3，也就是说一个TCP连接发送2-3个HTTP请求后就关闭了。在HTTP/2出现后，连接的复用率有了较大的提高。

在HTTP请求到达BFE后，步骤5至步骤8是BFE处理的关键步骤。

- 步骤 5：确定HTTP请求所属的租户

    多租户支持是BFE根据云场景所设计提供的能力。目前BFE可以根据HTTP请求头中的Host字段或HTTP请求的目标IP地址来确定租户。

    在本案例中，针对HTTP请求头中demo.example.com域名，BFE找到对应的租户为demo。

- 步骤 6：根据租户的分流规则，决定HTTP请求的目的集群
    - 对于这个请求，假设对应的目的集群为demo-static
    - 详见[基于内容路由](route.md)说明
- Step 7-8：BFE根据产品线的均衡策略，选择子集群及实例
    - 对于这个请求，假设子集群为demo-static.idc1，实例为demo-static-01.idc1
    - 详见[流量负载均衡](balance.md)说明





- Step 9：请求被发往后端实例demo-static-01.idc1
- Step 10：BFE收到后端实例回复的响应
- Step 11-12：BFE通过四层负载均衡设施，将响应返回给用户

## 多租户的进一步讨论

“多租户”支持是云计算系统的重要需求。在百度内部，BFE平台是一个支持多租户的平台，上千个租户混用同一组转发资源。