# BFE的路由转发机制

## 概述

在BFE的转发过程中，在确定请求所属的租户后，要根据HTTP报头的内容，进一步确定处理该请求的目标集群。在BFE内对每个租户维护一张独立的“转发表”。对于每个属于该租户的请求，通过查询转发表，获得目标集群。


## 转发表

转发表由多条“转发规则”组成。在查询时，对多条转发规则顺序查找；只要命中任何一条转发规则，就会结束退出。其中最后一条规则为“默认规则（Default）”。在所有转发规则都没有命中的时候，执行默认规则。

每条转发规则包括两部分：匹配条件，目标集群。其中匹配条件使用BFE自研的“条件表达式“（Condition Expression）来表述。



下图展示了一个转发表的例子。

在这个例子中，包含以下3种服务集群：

+ 静态集群(demo-static)：服务静态流量
+ post集群(demo-post)：服务post流量
+ main集群(demo-main)：服务其他流量

期望的转发逻辑如下：

+ 对于path以"/static"为前缀的，都发往demo-static集群
+ 请求方法为"POST"、且path以"/setting"为前缀的，都发往demo-post
+ 其它请求，都发往demo-main

在转发表中，使用条件表达式来描述以上转发条件。

![forwarding table](./bfe-forwarding-table.png)

## 条件表达式

条件表达式是BFE路由转发的核心机制，下面对条件表达式的设计思想和机制进行介绍。

### 设计思想

在使用Go语言重构BFE转发引擎之前，BFE使用正则表达式来描述转发的条件。在实践中，发现正则表达式存在以下2个严重问题：

+ 配置难以维护

  正则表达式存在严重的可读性问题。用正则表达式编写的转发条件很难看懂，且易存在二义性。也经常会发现一个人编写的分流条件，其他人很难接手继续维护。

+ 性能存在隐患

  对于编写不当的正则表达式，可能在特定的流量特征下出现严重的性能退化。在线上曾经发生过这样的情况：原本每秒可以处理几千请求的服务，由于增加了一个正则表达式描述，性能下降到每秒只能处理几十个请求。

针对正则表达式存在的问题，在重构BFE转发引擎时设计了条件表达式。条件表达式的设计中有以下思想：

+ 在表述中明确指定所使用的HTTP请求字段，提升可读性

  例如，从req_path_prefix_in()这样的名字，可以立刻看出是针对请求中的path部分进行前缀匹配；从req_method_in()可以看出是针对请求的method字段进行匹配。

+ 控制计算的复杂度，降低性能退化的风险

  条件表达式主要使用精确匹配、前缀匹配、后缀匹配等计算方式。这些计算方式的计算复杂度都较低。

### 基本概念

#### 条件原语

- 条件原语是基本的内置条件判断单元，执行某种比较来判断是否满足条件

``` go
// 如果请求host是"bfe-networks.com"或"bfe-networks.org", 返回true
req_host_in("bfe-networks.com|bfe-networks.org") 
```

+ 条件原语是判断的最小单元。按照请求、响应、会话、系统等几个分类，建立了几十个条件原语。

#### 条件表达式

- 条件表达式是多个条件原语与操作符(例如与、或、非)的组合

```go
// 如果请求域名是"bfe-networks.com"且请求方法是"GET", 返回true
req_host_in("bfe-networks.com") && req_method_in("GET") 
```

#### 条件变量

- 可以将条件表达式赋值给一个变量，这个变量被定义为条件变量

```go
// 将条件表达式赋值给变量bfe_host
bfe_host = req_host_in("bfe-networks.com") 
```

#### 高级条件表达式

- 高级条件表达式是多个条件原语和条件变量与操作符(例如与、或、非)的组合

- 在高级条件表达式中，条件变量以$前缀作为标示

```go
// 如果变量bfe_host为true且请求方法是"GET"，返回true
$bfe_host && req_method_in("GET") 
```

+ 条件变量和高级条件表达式的引入，是为了便于条件表达式逻辑的复用。

### 语法