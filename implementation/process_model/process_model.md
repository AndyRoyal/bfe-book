# 进程模型

BFE系统的转发实例由一组协同工作的进程组成（详见BFE简介章节）。这里以其中最核心的转发进程重点进行介绍。

BFE的转发进程是由golang语言编写、基于golang协程实现的高并发程序。BFE的转发进程中包含了几类重要的协程:

![process_model](./process_model.png)

- 网络相关协程：
 * 用户连接的监听协程、用户连接的处理协程, 以及协议有关的可选的用户请求处理协程。
 * 后端连接的建立协程、后端连接的读写协程

- 管理相关协程: 
 * 针对后端健康状态的检查协程
 * 监控及热加载请求的处理协程

- 辅助相关协程:
 * 扩展模块也可能创建协程，用于后台定期操作或异步执行处理
 * 例如：定期进行日志切割、异步更新缓存等

所有网络相关协程都利用了golang内置的PANIC恢复机制，可避免在请求处理过程中由于未知Bug导致程序PANIC退出。这些Bug可能在线下较难通过测试完全发现，但在一些情况下, 触发PANIC后对转发集群稳定性带来严重的影响(例如Bug由特定类型请求触发）

BFE协程可以充分利用多核CPU提升并发量及吞吐。但基于协程的并发模型也存在局限性：
- 难以绑定到某个固定的核以通过CPU亲缘性提升性能
- 并发能力与CPU核数并非呈线性增长(由于锁的存在)，当核数非常大时进一步增加核数可能并不能提升极限性能。

在实践中，一般通过针对转发场景定制机型或制定合适的容器规格，来避免这个问题。 
